<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scratch Pro | Advanced Engine</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed"></script>
    <script src="https://unpkg.com/blockly/msg/en"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #6366f1; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #main { flex: 1; display: flex; padding: 12px; gap: 12px; }
        #blocklyArea { flex: 1; background: var(--panel); border-radius: 12px; position: relative; border: 1px solid #334155; }
        #blocklyDiv { position: absolute; inset: 0; }
        #stage-area { width: 480px; display: flex; flex-direction: column; gap: 12px; }
        #stage { width: 480px; height: 360px; background: white; border-radius: 8px; position: relative; overflow: hidden; }
        .sprite { position: absolute; transform-origin: center; pointer-events: auto; cursor: move; }
        .console { flex: 1; background: #000; border-radius: 8px; font-family: monospace; padding: 10px; font-size: 12px; color: #10b981; overflow-y: auto; border: 1px solid #334155; }
        .controls { background: var(--panel); padding: 10px; border-radius: 8px; display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div id="main">
        <div id="blocklyArea"><div id="blocklyDiv"></div></div>
        <div id="stage-area">
            <div class="controls">
                <button id="run" class="bg-green-600 px-4 py-2 rounded font-bold"><i class="fas fa-flag"></i></button>
                <button id="stop" class="bg-red-600 px-4 py-2 rounded font-bold"><i class="fas fa-stop"></i></button>
                <div class="flex-1"></div>
                <button onclick="state.createSprite()" class="bg-slate-700 px-3 py-1 rounded text-xs">+ Sprite</button>
            </div>
            <div id="stage"></div>
            <div id="console" class="console"></div>
        </div>
    </div>

    <script src="blocks.js"></script>
    <script>
        const state = {
            entities: [], activeId: null, isRunning: false, mouse: {x:0, y:0},
            init() { this.createSprite('Cat'); },
            createSprite(name) {
                const id = 's' + Date.now();
                const e = { id, name: name || 'Sprite', x: 0, y: 0, dir: 90, scale: 100, visible: true, xml: '<xml></xml>', dom: null };
                this.entities.push(e); this.render(e); this.setActive(id);
            },
            render(e) {
                const div = document.createElement('div'); div.className = 'sprite';
                div.innerHTML = `<svg width="40" height="40" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#6366f1" stroke="white" stroke-width="5"/></svg>`;
                div.onmousedown = () => this.setActive(e.id);
                document.getElementById('stage').appendChild(div); e.dom = div; this.updateUI();
            },
            setActive(id) {
                if(this.activeId && workspace) this.entities.find(x=>x.id==this.activeId).xml = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace));
                this.activeId = id; const curr = this.entities.find(x=>x.id==id);
                workspace.clear(); if(curr.xml) Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(curr.xml), workspace);
            },
            updateUI() {
                this.entities.forEach(e => {
                    e.dom.style.left = (e.x + 240 - 20) + 'px';
                    e.dom.style.top = (180 - e.y - 20) + 'px';
                    e.dom.style.transform = `rotate(${e.dir - 90}deg) scale(${e.scale/100})`;
                    e.dom.style.display = e.visible ? 'block' : 'none';
                    e.dom.style.outline = e.id === this.activeId ? '2px solid #6366f1' : 'none';
                });
            }
        };

        const workspace = Blockly.inject('blocklyDiv', { toolbox: fullToolbox, theme: Blockly.Themes.Modern, renderer: 'zelos' });
        
        // Advanced Engine Functions
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        const log = m => { const c = document.getElementById('console'); c.innerHTML += `> ${m}<br>`; c.scrollTop = c.scrollHeight; };
        
        document.getElementById('run').onclick = () => {
            state.isRunning = true; log("System: Start");
            state.entities.forEach(ent => {
                const code = javascript.javascriptGenerator.workspaceToCode(Blockly.utils.xml.textToDom(ent.xml));
                const fn = new Function('self', 'state', 'sleep', 'log', `(async()=>{ ${code} })()`);
                fn(ent, state, sleep, log);
            });
        };
        document.getElementById('stop').onclick = () => location.reload();

        document.getElementById('stage').onmousemove = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            state.mouse.x = (e.clientX - rect.left) - 240;
            state.mouse.y = 180 - (e.clientY - rect.top);
        };

        window.onload = () => state.init();
    </script>
</body>
</html>
