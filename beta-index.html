<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scratch Zenith</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_generator.min.js"></script>
    <script src="https://unpkg.com/blockly/msg/en"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="assets/scratchzenith.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root {
            --bg-base: #020617;
            --bg-surface: rgba(15, 23, 42, 0.7);
            --bg-element: rgba(30, 41, 59, 0.8);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --scratch-green: #10b981;
            --scratch-red: #f43f5e;
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --glass: blur(12px) saturate(180%);
        }

        body.theme-high-contrast {
            --bg-base: #000000;
            --bg-surface: #111111;
            --bg-element: #222222;
            --accent: #ffffff;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: #444444;
        }

        body.theme-classic {
            --bg-base: #f8fafc;
            --bg-surface: rgba(255, 255, 255, 0.8);
            --bg-element: rgba(226, 232, 240, 0.8);
            --accent: #4f46e5;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        body { 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-base); 
            color: var(--text-primary); 
            font-family: var(--font-main); 
            overflow: hidden;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(168, 85, 247, 0.1) 0px, transparent 50%);
        }

        header {
            height: 64px;
            background: var(--bg-surface);
            backdrop-filter: var(--glass);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            justify-content: space-between;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 14px;
            font-weight: 800;
            letter-spacing: -0.04em;
            font-size: 1.25rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px var(--accent-glow);
        }

        #main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 16px;
            gap: 16px;
        }

        #blocklyArea {
            flex: 1;
            position: relative;
            background: var(--bg-surface);
            backdrop-filter: var(--glass);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }
        #blocklyDiv { position: absolute; top: 0; left: 0; bottom: 0; right: 0; }

        #side-panels {
            width: 420px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .panel-card {
            background: var(--bg-surface);
            backdrop-filter: var(--glass);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px -10px rgba(0,0,0,0.3);
        }

        #stage-header {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(255,255,255,0.03);
        }

        .btn-action {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            cursor: pointer;
        }

        .btn-action:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-action:active { transform: translateY(0px); }

        .btn-green { background: var(--scratch-green); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-red { background: var(--scratch-red); color: white; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); }
        .btn-ghost { background: var(--bg-element); color: var(--text-primary); border-color: var(--border-color); }

        #stage-wrapper {
            padding: 20px;
            display: flex;
            justify-content: center;
            background: rgba(0,0,0,0.2);
        }

        #stage {
            width: 380px;
            height: 285px;
            background: #000;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            user-select: none;
        }

        .manager-header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.02);
        }

        .manager-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .stage-selector {
            width: 90px;
            border-right: 1px solid var(--border-color);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            background: rgba(0,0,0,0.15);
        }

        .sprite-list-container {
            flex: 1;
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            grid-auto-rows: min-content;
            gap: 12px;
            overflow-y: auto;
        }

        .sprite-thumb {
            aspect-ratio: 1;
            background: var(--bg-element);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .sprite-thumb:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .sprite-thumb.active {
            border-color: var(--accent);
            background: var(--accent-glow);
            box-shadow: 0 0 15px var(--accent-glow);
            transform: scale(1.02);
        }

        .sprite-thumb span {
            font-size: 10px;
            margin-top: 6px;
            color: var(--text-secondary);
            font-weight: 700;
            max-width: 60px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .console-area {
            height: 140px;
            background: rgba(2, 6, 23, 0.8);
            color: #10b981;
            font-family: var(--font-mono);
            font-size: 11px;
            padding: 16px;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
        }

        .theme-switcher {
            display: flex;
            background: var(--bg-element);
            padding: 4px;
            border-radius: 10px;
            gap: 2px;
            border: 1px solid var(--border-color);
        }
        .theme-pill {
            padding: 6px 14px;
            border-radius: 7px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-pill.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 10px var(--accent-glow);
        }

        /* Blockly Overrides */
        .blocklyMainBackground { stroke: none !important; fill: transparent !important; }
        .blocklyToolboxDiv { background-color: transparent !important; border-right: 1px solid var(--border-color) !important; padding: 10px 0; }
        .blocklyFlyoutBackground { fill: var(--bg-surface) !important; fill-opacity: 0.95 !important; }
        .blocklyTreeLabel { font-family: var(--font-main) !important; font-weight: 600 !important; font-size: 13px !important; color: var(--text-secondary) !important; }
        .blocklyTreeRow.blocklyTreeSelected .blocklyTreeLabel { color: var(--text-primary) !important; }
        
        .blocklyToolboxDiv .blocklyScrollbarHorizontal,
        .blocklyToolboxDiv .blocklyScrollbarVertical {
            display: none !important;
        }

        #stage-backdrop {
            position: absolute;
            inset: 0;
            z-index: 0;
            background-size: cover;
            background-position: center;
            transition: all 0.5s ease;
        }

        .sprite-entity { 
            position: absolute; 
            z-index: 20; 
            cursor: grab; 
            transition: transform 0.0s ease-out; /* Removed smooth trans for better game response */
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sprite-entity:active { cursor: grabbing; }
        .sprite-entity.active::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--accent);
            border-radius: 8px;
            animation: pulse 2s infinite;
        }

        .speech-bubble {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: black;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            border: 2px solid #ccc;
            margin-bottom: 8px;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        .speech-bubble.visible { opacity: 1; }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-element); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body class="theme-midnight">

    <header>
        <div class="logo-container">
            <div class="logo-icon"><i class="fas fa-bolt-lightning text-white text-sm"></i></div>
            <span class="tracking-tight">SCRATCH <span class="text-indigo-400 font-black">ZENITH</span></span>
        </div>
        
        <div class="flex items-center gap-8">
            <div class="theme-switcher">
                <div onclick="setTheme('classic')" class="theme-pill" id="pill-classic">Classic</div>
                <div onclick="setTheme('midnight')" class="theme-pill active" id="pill-midnight">Midnight</div>
                <div onclick="setTheme('high-contrast')" class="theme-pill" id="pill-high-contrast">Focus</div>
            </div>
            <button id="openModBtn" class="bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 px-3 py-2 rounded-lg transition-all border border-indigo-500/20">
                <i class="fas fa-code"></i>
            </button>
            <button id="saveBtn" class="bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 px-3 py-2 rounded-lg transition-all border border-emerald-500/20" title="Save Project">
                <i class="fas fa-save"></i>
            </button>
            <button id="loadBtn" class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 px-3 py-2 rounded-lg transition-all border border-amber-500/20" title="Load Project">
                <i class="fas fa-folder-open"></i>
            </button>
            <button id="demoBtn" class="bg-purple-500/10 hover:bg-purple-500/20 text-purple-400 px-3 py-2 rounded-lg transition-all border border-purple-500/20" title="Load Game Demo">
                <i class="fas fa-gamepad"></i>
            </button>
        </div>
    </header>

    <div id="main-container">
        <div id="blocklyArea">
            <div id="blocklyDiv"></div>
        </div>

        <div id="side-panels">
            <div class="panel-card">
                <div id="stage-header">
                    <button id="runBtn" class="btn-action btn-green">
                        <i class="fas fa-flag"></i> Run
                    </button>
                    <button id="stopBtn" class="btn-action btn-red">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <div class="flex-1"></div>
                    <button id="addSpriteBtn" class="btn-action btn-ghost">
                        <i class="fas fa-plus"></i> Sprite
                    </button>
                    <button id="undoBtn" class="btn-action btn-ghost" title="Undo">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button id="redoBtn" class="btn-action btn-ghost" title="Redo">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>

                <div id="stage-wrapper">
                    <div id="stage">
                        <div id="stage-backdrop"></div>
                    </div>
                </div>
            </div>

            <div class="panel-card flex-1" id="sprite-manager">
                <div class="manager-header">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-indigo-400 animate-pulse"></div>
                        <span class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest">Workspace</span>
                    </div>
                    <span id="active-name" class="text-xs font-mono font-bold text-indigo-400 bg-indigo-500/10 px-3 py-1 rounded-full border border-indigo-500/10">Loading...</span>
                </div>
                <div class="manager-body">
                    <div class="stage-selector" id="stage-thumb-container">
                        <!-- Stage Thumb -->
                    </div>
                    <div id="sprite-list" class="sprite-list-container">
                        <!-- Sprite Gallery -->
                    </div>
                </div>
                <div id="console" class="console-area"></div>
            </div>
        </div>
    </div>

    <!-- Mod Panel -->
    <div id="modPanel" class="fixed inset-0 bg-slate-950/60 backdrop-blur-md z-[200] hidden items-center justify-center p-6">
        <div class="bg-slate-900 rounded-3xl w-full max-w-xl border border-white/10 shadow-2xl overflow-hidden">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/2">
                <div>
                    <h2 class="font-extrabold text-white text-xl">JS Kernel Injection</h2>
                    <p class="text-slate-400 text-sm">Direct runtime modification</p>
                </div>
                <button id="closeModBtn" class="bg-white/5 hover:bg-white/10 w-10 h-10 rounded-full text-slate-400 hover:text-white transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <textarea id="modInput" class="w-full h-64 bg-black/40 p-5 rounded-2xl border border-white/10 font-mono text-sm text-indigo-300 focus:outline-none focus:border-indigo-500/50 transition-all resize-none" placeholder="// Input runtime JS code here..."></textarea>
                <div class="flex gap-3">
                    <button id="loadModBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-4 rounded-2xl font-bold transition-all shadow-xl shadow-indigo-600/20 active:scale-95">Inject to Kernel</button>
                    <button id="clearModBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-4 rounded-2xl font-bold transition-all">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="Motion" colour="#4C97FF">
            <block type="motion_move"><value name="STEPS"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="motion_turnright"><value name="DEGREES"><shadow type="math_number"><field name="NUM">15</field></shadow></value></block>
            <block type="motion_turnleft"><value name="DEGREES"><shadow type="math_number"><field name="NUM">15</field></shadow></value></block>
            <block type="motion_goto_xy"><value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value><value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
            <block type="motion_goto_random"></block>
            <block type="motion_glideto_xy">
                <value name="SECS"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
            </block>
            <block type="motion_pointindirection"><value name="DIRECTION"><shadow type="math_number"><field name="NUM">90</field></shadow></value></block>
            <block type="motion_pointtowards"><value name="TOWARDS"><shadow type="text"><field name="TEXT">mouse</field></shadow></value></block>
            <block type="motion_changex"><value name="DX"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="motion_setx"><value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
            <block type="motion_changey"><value name="DY"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="motion_sety"><value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
            <block type="motion_ifonedgebounce"></block>
            <block type="motion_setrotationstyle"></block>
            <block type="motion_xposition"></block>
            <block type="motion_yposition"></block>
            <block type="motion_direction"></block>
        </category>
        
        <category name="Looks" colour="#9966FF">
            <block type="looks_say"><value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value></block>
            <block type="looks_sayforsecs">
                <value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value>
                <value name="SECS"><shadow type="math_number"><field name="NUM">2</field></shadow></value>
            </block>
            <block type="looks_switchcostume"><value name="COSTUME"><shadow type="text"><field name="TEXT">star</field></shadow></value></block>
            <block type="looks_nextcostume"></block>
            <block type="looks_changeeffect"><field name="EFFECT">COLOR</field><value name="CHANGE"><shadow type="math_number"><field name="NUM">25</field></shadow></value></block>
            <block type="looks_seteffect"><field name="EFFECT">COLOR</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow></value></block>
            <block type="looks_cleareffects"></block>
            <block type="looks_changesize"><value name="CHANGE"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="looks_setsize"><value name="SIZE"><shadow type="math_number"><field name="NUM">100</field></shadow></value></block>
            <block type="looks_show"></block>
            <block type="looks_hide"></block>
            <block type="looks_gotofrontback"></block>
            <block type="looks_size"></block>
        </category>
        
        <category name="Sound" colour="#D65CD6">
            <block type="sound_play"><value name="SOUND"><shadow type="text"><field name="TEXT">beep</field></shadow></value></block>
        </category>
        
        <category name="Events" colour="#FFBF00">
            <block type="event_whenflagclicked"></block>
            <block type="event_whenkeypressed"><field name="KEY">space</field></block>
            <block type="event_whenthisspriteclicked"></block>
            <block type="event_broadcast"><value name="MESSAGE"><shadow type="text"><field name="TEXT">message1</field></shadow></value></block>
            <block type="event_whenbroadcastreceived"><field name="MESSAGE">message1</field></block>
        </category>
        
        <category name="Control" colour="#FFAB19">
            <block type="control_wait"><value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
            <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="control_forever"></block>
            <block type="controls_if"></block>
            <block type="controls_if_else"></block>
            <block type="control_wait_until"></block>
            <block type="control_repeat_until"></block>
            <block type="control_stop"></block>
            <block type="control_start_as_clone"></block>
            <block type="control_create_clone"><value name="CLONE_OPTION"><shadow type="text"><field name="TEXT">myself</field></shadow></value></block>
            <block type="control_delete_this_clone"></block>
        </category>
        
        <category name="Sensing" colour="#4CBFE6">
            <block type="sensing_touchingobject"><value name="TOUCHINGOBJECTMENU"><shadow type="text"><field name="TEXT">mouse</field></shadow></value></block>
            <block type="sensing_distanceto"><value name="DISTANCETOMENU"><shadow type="text"><field name="TEXT">mouse</field></shadow></value></block>
            <block type="sensing_askandwait"><value name="QUESTION"><shadow type="text"><field name="TEXT">What's your name?</field></shadow></value></block>
            <block type="sensing_answer"></block>
            <block type="sensing_keypressed"><value name="KEY_OPTION"><shadow type="text"><field name="TEXT">space</field></shadow></value></block>
            <block type="sensing_mousedown"></block>
            <block type="sensing_mousex"></block>
            <block type="sensing_mousey"></block>
            <block type="sensing_timer"></block>
            <block type="sensing_resettimer"></block>
        </category>
        
        <category name="Operators" colour="#40BF4A">
            <block type="operator_add"><value name="NUM1"><shadow type="math_number"><field name="NUM"></field></shadow></value><value name="NUM2"><shadow type="math_number"><field name="NUM"></field></shadow></value></block>
            <block type="operator_subtract"><value name="NUM1"><shadow type="math_number"><field name="NUM"></field></shadow></value><value name="NUM2"><shadow type="math_number"><field name="NUM"></field></shadow></value></block>
            <block type="operator_multiply"><value name="NUM1"><shadow type="math_number"><field name="NUM"></field></shadow></value><value name="NUM2"><shadow type="math_number"><field name="NUM"></field></shadow></value></block>
            <block type="operator_divide"><value name="NUM1"><shadow type="math_number"><field name="NUM"></field></shadow></value><value name="NUM2"><shadow type="math_number"><field name="NUM"></field></shadow></value></block>
            <block type="operator_random"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="operator_gt"><value name="OPERAND1"><shadow type="text"><field name="TEXT"></field></shadow></value><value name="OPERAND2"><shadow type="text"><field name="TEXT">50</field></shadow></value></block>
            <block type="operator_lt"><value name="OPERAND1"><shadow type="text"><field name="TEXT"></field></shadow></value><value name="OPERAND2"><shadow type="text"><field name="TEXT">50</field></shadow></value></block>
            <block type="operator_equals"><value name="OPERAND1"><shadow type="text"><field name="TEXT"></field></shadow></value><value name="OPERAND2"><shadow type="text"><field name="TEXT">50</field></shadow></value></block>
            <block type="operator_and"></block>
            <block type="operator_or"></block>
            <block type="operator_not"></block>
            <block type="operator_join"><value name="STRING1"><shadow type="text"><field name="TEXT">hello </field></shadow></value><value name="STRING2"><shadow type="text"><field name="TEXT">world</field></shadow></value></block>
            <block type="operator_mod"><value name="NUM1"><shadow type="math_number"><field name="NUM">10</field></shadow></value><value name="NUM2"><shadow type="math_number"><field name="NUM">3</field></shadow></value></block>
            <block type="operator_round"><value name="NUM"><shadow type="math_number"><field name="NUM">3.14</field></shadow></value></block>
        </category>
        
        <category name="Variables" colour="#FF8C1A" custom="VARIABLE"></category>
        <category name="My Blocks" colour="#FF6680" custom="PROCEDURE"></category>
    </xml>

    <script>
        class ProjectState {
            constructor() {
                this.entities = [];
                this.clones = []; // Active clones
                this.stageEntity = null;
                this.activeEntityId = null;
                this.stage = { w: 380, h: 285 };
                this.abortController = null;
                this.backdrops = {
                    'Void': '#000000',
                    'Deep Space': 'linear-gradient(45deg, #020617 0%, #1e1b4b 100%)',
                    'Neon Grid': 'linear-gradient(rgba(99, 102, 241, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(99, 102, 241, 0.1) 1px, transparent 1px), #020617',
                    'Sunset': 'linear-gradient(180deg, #f97316 0%, #7c3aed 100%)',
                    'Matrix': 'linear-gradient(rgba(16, 185, 129, 0.05) 2px, transparent 2px), linear-gradient(90deg, rgba(16, 185, 129, 0.05) 2px, transparent 2px), #000'
                };
                this.currentBackdrop = 'Deep Space';
                this.costumes = { 
                    'star': 'M50 15 L58 42 L85 42 L63 58 L71 85 L50 68 L29 85 L37 58 L15 42 L42 42 Z',
                    'cat': 'M50 20 L60 35 L75 40 L65 50 L70 65 L50 55 L30 65 L35 50 L25 40 L40 35 Z',
                    'robot': 'M30 20 L70 20 L75 40 L70 60 L30 60 L25 40 Z M40 25 L45 35 M55 25 L60 35 M45 50 L55 50'
                };
                
                this.keyState = {};
                this.mouseX = 0;
                this.mouseY = 0;
                this.mouseDown = false;
                this.timerStart = Date.now();
                this.lastAnswer = "";
            }
            
            init() {
                this.stageEntity = {
                    id: 'STAGE',
                    name: 'Stage',
                    isStage: true,
                    xml: '<xml xmlns="https://developers.google.com/blockly/xml"></xml>',
                    vars: {}
                };
                
                this.renderStageThumb();
                this.createSprite('Sprite1');
                this.setActive('s_0');
                this.setupInputListeners();
            }
            
            createSprite(name = null, isClone = false, prototype = null) {
                const id = isClone ? `clone_${Date.now()}_${Math.random()}` : `s_${this.entities.length}`;
                const base = prototype || {
                    x: this.stage.w / 2, 
                    y: this.stage.h / 2, 
                    direction: 90, 
                    costume: 'star', 
                    size: 100,
                    visible: true,
                    rotationStyle: 'all around',
                    effects: {
                        color: 0, ghost: 0, brightness: 0
                    },
                    xml: '<xml xmlns="https://developers.google.com/blockly/xml"></xml>',
                    vars: {}
                };

                const entity = { 
                    id, 
                    name: name || `Sprite${this.entities.length + 1}`, 
                    x: base.x,
                    y: base.y,
                    direction: base.direction,
                    costume: base.costume,
                    size: base.size,
                    visible: base.visible,
                    rotationStyle: base.rotationStyle,
                    effects: { ...base.effects },
                    isStage: false,
                    isClone: isClone,
                    xml: base.xml,
                    vars: JSON.parse(JSON.stringify(base.vars)),
                    dom: null,
                    bubble: null
                };

                if (isClone) {
                    this.clones.push(entity);
                } else {
                    this.entities.push(entity);
                }
                
                this.renderSprite(entity);
                
                if (!isClone) {
                    this.setActive(id);
                    this.updateList();
                }
                return entity;
            }
            
            renderSprite(entity) {
                const div = document.createElement('div');
                div.className = 'sprite-entity';
                div.style.width = '44px';
                div.style.height = '44px';
                
                // SVG Content
                div.innerHTML = `
                    <svg viewBox="0 0 100 100" class="w-full h-full" style="overflow:visible">
                        <path d="${this.costumes[entity.costume] || this.costumes.star}" 
                              fill="var(--accent)" 
                              stroke="rgba(255,255,255,0.4)" 
                              stroke-width="3"/>
                    </svg>
                    <div class="speech-bubble" id="bubble-${entity.id}"></div>
                `;

                div.onclick = (e) => { 
                    e.stopPropagation(); 
                    if(!entity.isClone) this.setActive(entity.id);
                    // Broadcast click event
                    this.triggerEvent('event_whenthisspriteclicked', entity);
                };
                
                // Draggable logic
                let isDragging = false;
                div.onmousedown = (e) => { 
                    if(e.button !== 0) return;
                    e.stopPropagation();
                    isDragging = true; 
                    if(!entity.isClone) this.setActive(entity.id);
                    
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const entStartX = entity.x;
                    const entStartY = entity.y;

                    const onMouseMove = (ev) => {
                        if (!isDragging) return;
                        // Calculate delta relative to stage coordinates
                        entity.x = entStartX + (ev.clientX - startX);
                        entity.y = entStartY + (ev.clientY - startY);
                        // Clamp to stage (roughly)
                        entity.x = Math.max(-50, Math.min(this.stage.w + 50, entity.x));
                        entity.y = Math.max(-50, Math.min(this.stage.h + 50, entity.y));
                        this.updateEntityVisuals(entity);
                    };
                    
                    const onMouseUp = () => {
                        isDragging = false;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        div.style.cursor = 'grab';
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    div.style.cursor = 'grabbing';
                };

                document.getElementById('stage').appendChild(div);
                entity.dom = div;
                entity.bubble = div.querySelector('.speech-bubble');
                this.updateEntityVisuals(entity);
            }
            
            updateEntityVisuals(e) {
                if (!e.dom) return;
                
                // Visibility
                e.dom.style.display = e.visible ? 'flex' : 'none';
                if (!e.visible) return;

                // Position (centered)
                e.dom.style.left = `${e.x - 22}px`;
                e.dom.style.top = `${e.y - 22}px`;
                
                // Transform: Direction + Size + Rotation Style
                let rot = e.direction - 90;
                let scaleX = 1;
                
                if (e.rotationStyle === 'left-right') {
                    rot = 0;
                    if (e.direction < 0 || e.direction > 180) scaleX = -1;
                } else if (e.rotationStyle === 'dont rotate') {
                    rot = 0;
                }

                e.dom.style.transform = `
                    rotate(${rot}deg) 
                    scaleX(${scaleX * (e.size/100)}) 
                    scaleY(${e.size/100})
                `;
                
                // Effects (Filter)
                let filters = [];
                if (e.effects.color !== 0) filters.push(`hue-rotate(${e.effects.color * 3.6}deg)`);
                if (e.effects.brightness !== 0) filters.push(`brightness(${100 + e.effects.brightness}%)`);
                if (e.effects.ghost !== 0) e.dom.style.opacity = 1 - (e.effects.ghost / 100);
                else e.dom.style.opacity = 1;

                e.dom.querySelector('path').style.filter = filters.join(' ');

                // Active Halo
                e.dom.classList.toggle('active', e.id === this.activeEntityId);
            }

            renderStageThumb() {
                const container = document.getElementById('stage-thumb-container');
                if (container) {
                    container.innerHTML = `
                        <div id="thumb-STAGE" class="sprite-thumb w-full flex-1" onclick="state.setActive('STAGE')">
                            <i class="fas fa-globe text-xl opacity-60"></i>
                            <span>Stage</span>
                        </div>
                    `;
                }
            }

            setActive(id) {
                const old = this.getActiveEntity();
                if (old && typeof workspace !== 'undefined' && workspace && !old.isClone) {
                    old.xml = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace));
                }
                
                this.activeEntityId = id; 
                const current = this.getActiveEntity();
                
                if (current && typeof workspace !== 'undefined' && workspace) {
                    workspace.clear();
                    try {
                        const dom = Blockly.utils.xml.textToDom(current.xml);
                        Blockly.Xml.domToWorkspace(dom, workspace);
                    } catch(e) { console.error('XML Load Error', e); }
                }
                this.updateList();
            }
            
            getActiveEntity() { 
                if (this.activeEntityId === 'STAGE') return this.stageEntity;
                return this.entities.find(e => e.id === this.activeEntityId); 
            }
            
            updateList() {
                const list = document.getElementById('sprite-list');
                if (!list) return;
                list.innerHTML = '';
                
                this.entities.forEach(e => {
                    const thumb = document.createElement('div');
                    thumb.className = `sprite-thumb ${e.id === this.activeEntityId ? 'active' : ''}`;
                    thumb.innerHTML = `<svg class="w-8 h-8" viewBox="0 0 100 100"><path d="${this.costumes[e.costume] || this.costumes.star}" fill="var(--accent)"/></svg><span title="${e.name}">${e.name}</span>`;
                    thumb.onclick = () => this.setActive(e.id);
                    list.appendChild(thumb);
                });

                const stageThumb = document.getElementById('thumb-STAGE');
                if (stageThumb) stageThumb.className = `sprite-thumb w-full flex-1 ${this.activeEntityId === 'STAGE' ? 'active' : ''}`;
                
                const nameLabel = document.getElementById('active-name');
                if (nameLabel) nameLabel.innerText = this.getActiveEntity()?.name || 'Null';
            }

            updateGlobalUI() {
                // Backdrop
                const stageDiv = document.getElementById('stage-backdrop');
                if (stageDiv) {
                    const val = this.backdrops[this.currentBackdrop];
                    stageDiv.style.background = val;
                    if (val.includes('grid') || val.includes('Matrix')) {
                        stageDiv.style.backgroundSize = '30px 30px';
                    }
                }
                // Update all entities
                [...this.entities, ...this.clones].forEach(e => this.updateEntityVisuals(e));
            }

            // ================== RUNTIME ENGINE ==================

            async triggerEvent(type, targetEntity = null, matchField = null, matchValue = null) {
                const targets = targetEntity ? [targetEntity] : [...this.entities, ...this.clones, this.stageEntity];
                
                for (const entity of targets) {
                    const tempWs = new Blockly.Workspace();
                    try {
                        // For clones, we use their stored XML. 
                        Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(entity.xml), tempWs);
                        const blocks = tempWs.getBlocksByType(type);
                        
                        for (const block of blocks) {
                            // Check filters (e.g. Key Press key, Broadcast message)
                            if (matchField) {
                                const val = block.getFieldValue(matchField);
                                if (val !== matchValue) continue;
                            }

                            const next = block.getNextBlock();
                            if (next) {
                                this.executeStack(next, entity);
                            }
                        }
                    } catch(e) { console.error(e); }
                    finally { tempWs.dispose(); }
                }
            }

            executeStack(block, entity) {
                const code = gen.blockToCode(block);
                const fn = new Function('state', 'self', 'blocklyRuntime', `(async()=>{ 
                    try { ${code} } 
                    catch(e){ 
                        if(e.message !== 'ABORTED') 
                            blocklyRuntime.log("Error in " + self.name + ": " + e.message); 
                    } 
                })()`);
                
                fn(this, entity, {
                    log: logToConsole,
                    sleep: sleep,
                    move: moveSprite,
                    checkCollision: checkCollision,
                    ask: askUser
                });
            }

            setupInputListeners() {
                document.addEventListener('keydown', (e) => {
                    this.keyState[e.key] = true;
                    this.triggerEvent('event_whenkeypressed', null, 'KEY', e.key);
                    // Map special keys
                    if(e.key === ' ') this.triggerEvent('event_whenkeypressed', null, 'KEY', 'space');
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keyState[e.key] = false;
                });
                
                const stage = document.getElementById('stage');
                stage.addEventListener('mousemove', (e) => {
                    const rect = stage.getBoundingClientRect();
                    this.mouseX = e.clientX - rect.left;
                    this.mouseY = e.clientY - rect.top;
                });
                
                stage.addEventListener('mousedown', () => { this.mouseDown = true; });
                stage.addEventListener('mouseup', () => { this.mouseDown = false; });
                stage.addEventListener('mouseleave', () => { this.mouseDown = false; });
            }
        }

        // ================== HELPER FUNCTIONS ==================
        
        const state = new ProjectState();

        const sleep = (ms) => new Promise((resolve, reject) => {
            if(!state.abortController) return resolve(); 
            const timeout = setTimeout(resolve, ms);
            state.abortController.signal.addEventListener('abort', () => {
                clearTimeout(timeout);
                reject(new Error('ABORTED'));
            });
        });

        const logToConsole = (msg) => {
            const c = document.getElementById('console');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            c.innerHTML += `<div class="mb-1 border-l-2 border-indigo-500/30 pl-2"><span class="text-indigo-500/60 font-mono text-[10px]">${time}</span> <span class="text-slate-200">${msg}</span></div>`;
            c.scrollTop = c.scrollHeight;
        };

        async function moveSprite(entity, steps) { 
            const r = (entity.direction - 90) * (Math.PI / 180); 
            entity.x += Math.cos(r) * steps; 
            entity.y += Math.sin(r) * steps; 
            state.updateEntityVisuals(entity);
            await sleep(16);
        }

        function checkCollision(entity, targetName) {
            if(targetName === 'mouse') {
                const dist = Math.sqrt(Math.pow(entity.x - state.mouseX, 2) + Math.pow(entity.y - state.mouseY, 2));
                return dist < (entity.size / 2); // Simple radius check
            }
            
            // Find target sprite
            const target = state.entities.find(e => e.name === targetName) || state.clones.find(e => e.name === targetName);
            if(!target) return false;

            const dist = Math.sqrt(Math.pow(entity.x - target.x, 2) + Math.pow(entity.y - target.y, 2));
            return dist < (entity.size/2 + target.size/2) * 0.4; // Approximated collision
        }

        async function askUser(question) {
            const ans = prompt(question);
            state.lastAnswer = ans || "";
        }
        
        // Audio Synth
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        function setTheme(theme) {
            document.body.className = `theme-${theme}`;
            document.querySelectorAll('.theme-pill').forEach(p => p.classList.remove('active'));
            document.getElementById(`pill-${theme}`)?.classList.add('active');
        }

        // ================== BLOCKLY DEFINITIONS ==================
        // Note: Re-defining init on standard blocks to ensure compatibility
        
        Blockly.Blocks['motion_move'] = { 
            init: function() { this.appendValueInput("STEPS").setCheck("Number").appendField("move"); this.appendDummyInput().appendField("steps"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); } 
        };
        Blockly.Blocks['motion_turnright'] = {
            init: function() { this.appendValueInput("DEGREES").setCheck("Number").appendField("turn ↻"); this.appendDummyInput().appendField("degrees"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_turnleft'] = {
            init: function() { this.appendValueInput("DEGREES").setCheck("Number").appendField("turn ↺"); this.appendDummyInput().appendField("degrees"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_goto_xy'] = { 
            init: function() { this.appendDummyInput().appendField("go to x:"); this.appendValueInput("X").setCheck("Number"); this.appendDummyInput().appendField("y:"); this.appendValueInput("Y").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); } 
        };
        Blockly.Blocks['motion_glideto_xy'] = { 
            init: function() { this.appendDummyInput().appendField("glide"); this.appendValueInput("SECS").setCheck("Number"); this.appendDummyInput().appendField("secs to x:"); this.appendValueInput("X").setCheck("Number"); this.appendDummyInput().appendField("y:"); this.appendValueInput("Y").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); } 
        };
        Blockly.Blocks['motion_pointindirection'] = {
            init: function() { this.appendDummyInput().appendField("point in direction"); this.appendValueInput("DIRECTION").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_pointtowards'] = {
            init: function() { this.appendDummyInput().appendField("point towards"); this.appendValueInput("TOWARDS"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_changex'] = {
            init: function() { this.appendDummyInput().appendField("change x by"); this.appendValueInput("DX").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_setx'] = {
            init: function() { this.appendDummyInput().appendField("set x to"); this.appendValueInput("X").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_changey'] = {
            init: function() { this.appendDummyInput().appendField("change y by"); this.appendValueInput("DY").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_sety'] = {
            init: function() { this.appendDummyInput().appendField("set y to"); this.appendValueInput("Y").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_ifonedgebounce'] = {
            init: function() { this.appendDummyInput().appendField("if on edge, bounce"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_setrotationstyle'] = {
            init: function() { this.appendDummyInput().appendField("set rotation style").appendField(new Blockly.FieldDropdown([["left-right", "left-right"], ["don't rotate", "dont rotate"], ["all around", "all around"]]), "STYLE"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); }
        };
        Blockly.Blocks['motion_xposition'] = { init: function() { this.appendDummyInput().appendField("x position"); this.setOutput(true, "Number"); this.setColour("#4C97FF"); } };
        Blockly.Blocks['motion_yposition'] = { init: function() { this.appendDummyInput().appendField("y position"); this.setOutput(true, "Number"); this.setColour("#4C97FF"); } };
        Blockly.Blocks['motion_direction'] = { init: function() { this.appendDummyInput().appendField("direction"); this.setOutput(true, "Number"); this.setColour("#4C97FF"); } };
        Blockly.Blocks['motion_goto_random'] = { init: function() { this.appendDummyInput().appendField("go to random position"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4C97FF"); } };

        // Looks
        Blockly.Blocks['looks_say'] = { init: function() { this.appendDummyInput().appendField("say"); this.appendValueInput("MESSAGE"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_sayforsecs'] = { init: function() { this.appendDummyInput().appendField("say"); this.appendValueInput("MESSAGE"); this.appendDummyInput().appendField("for"); this.appendValueInput("SECS").setCheck("Number"); this.appendDummyInput().appendField("seconds"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_switchcostume'] = { init: function() { this.appendDummyInput().appendField("switch costume to"); this.appendValueInput("COSTUME"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_nextcostume'] = { init: function() { this.appendDummyInput().appendField("next costume"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_changeeffect'] = { init: function() { this.appendDummyInput().appendField("change").appendField(new Blockly.FieldDropdown([["color", "COLOR"], ["brightness", "BRIGHTNESS"], ["ghost", "GHOST"]]), "EFFECT").appendField("effect by"); this.appendValueInput("CHANGE").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_seteffect'] = { init: function() { this.appendDummyInput().appendField("set").appendField(new Blockly.FieldDropdown([["color", "COLOR"], ["brightness", "BRIGHTNESS"], ["ghost", "GHOST"]]), "EFFECT").appendField("effect to"); this.appendValueInput("VALUE").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_cleareffects'] = { init: function() { this.appendDummyInput().appendField("clear graphic effects"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_changesize'] = { init: function() { this.appendDummyInput().appendField("change size by"); this.appendValueInput("CHANGE").setCheck("Number"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_setsize'] = { init: function() { this.appendDummyInput().appendField("set size to"); this.appendValueInput("SIZE").setCheck("Number"); this.appendDummyInput().appendField("%"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_show'] = { init: function() { this.appendDummyInput().appendField("show"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_hide'] = { init: function() { this.appendDummyInput().appendField("hide"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_gotofrontback'] = { init: function() { this.appendDummyInput().appendField("go to front layer"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#9966FF"); } };
        Blockly.Blocks['looks_size'] = { init: function() { this.appendDummyInput().appendField("size"); this.setOutput(true, "Number"); this.setColour("#9966FF"); } };

        // Events
        Blockly.Blocks['event_whenflagclicked'] = { init: function() { this.appendDummyInput().appendField("when").appendField(new Blockly.FieldImage("https://scratch.mit.edu/static/assets/40432658145e7f1e63a129d5926ec25d.svg", 16, 16, "green flag")).appendField("clicked"); this.setNextStatement(true); this.setColour("#FFBF00"); this.hat='cap'; } };
        Blockly.Blocks['event_whenkeypressed'] = { init: function() { this.appendDummyInput().appendField("when").appendField(new Blockly.FieldDropdown([["space", "space"], ["up arrow", "ArrowUp"], ["down arrow", "ArrowDown"], ["right arrow", "ArrowRight"], ["left arrow", "ArrowLeft"], ["a", "a"], ["b", "b"], ["w", "w"], ["s", "s"]]), "KEY").appendField("key pressed"); this.setNextStatement(true); this.setColour("#FFBF00"); this.hat = 'cap'; } };
        Blockly.Blocks['event_whenthisspriteclicked'] = { init: function() { this.appendDummyInput().appendField("when this sprite clicked"); this.setNextStatement(true); this.setColour("#FFBF00"); this.hat = 'cap'; } };
        Blockly.Blocks['event_broadcast'] = { init: function() { this.appendValueInput("MESSAGE").setCheck("String").appendField("broadcast"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFBF00"); } };
        Blockly.Blocks['event_whenbroadcastreceived'] = { init: function() { this.appendDummyInput().appendField("when I receive").appendField(new Blockly.FieldTextInput("message1"), "MESSAGE"); this.setNextStatement(true); this.setColour("#FFBF00"); this.hat='cap'; } };

        // Control
        Blockly.Blocks['control_wait'] = { init: function() { this.appendDummyInput().appendField("wait"); this.appendValueInput("DURATION").setCheck("Number"); this.appendDummyInput().appendField("seconds"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['control_forever'] = { init: function() { this.appendDummyInput().appendField("forever"); this.appendStatementInput("DO"); this.setPreviousStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['controls_repeat_ext'] = { init: function() { this.appendValueInput("TIMES").setCheck("Number").appendField("repeat"); this.appendDummyInput().appendField("times"); this.appendStatementInput("DO"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['controls_if'] = { init: function() { this.appendValueInput("IF0").setCheck("Boolean").appendField("if"); this.appendStatementInput("DO0").appendField("then"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['controls_if_else'] = { init: function() { this.appendValueInput("IF0").setCheck("Boolean").appendField("if"); this.appendStatementInput("DO0").appendField("then"); this.appendDummyInput().appendField("else"); this.appendStatementInput("ELSE"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['control_wait_until'] = { init: function() { this.appendValueInput("CONDITION").setCheck("Boolean").appendField("wait until"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['control_repeat_until'] = { init: function() { this.appendValueInput("CONDITION").setCheck("Boolean").appendField("repeat until"); this.appendStatementInput("DO"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['control_stop'] = { init: function() { this.appendDummyInput().appendField("stop all"); this.setPreviousStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['control_start_as_clone'] = { init: function() { this.appendDummyInput().appendField("when I start as a clone"); this.setNextStatement(true); this.setColour("#FFAB19"); this.hat = 'cap'; } };
        Blockly.Blocks['control_create_clone'] = { init: function() { this.appendValueInput("CLONE_OPTION").appendField("create clone of"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#FFAB19"); } };
        Blockly.Blocks['control_delete_this_clone'] = { init: function() { this.appendDummyInput().appendField("delete this clone"); this.setPreviousStatement(true); this.setColour("#FFAB19"); } };

        // Sound
        Blockly.Blocks['sound_play'] = { init: function() { this.appendDummyInput().appendField("start sound").appendField(new Blockly.FieldTextInput("beep"), "SOUND"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#D65CD6"); } };

        // Sensing
        Blockly.Blocks['sensing_touchingobject'] = { init: function() { this.appendValueInput("TOUCHINGOBJECTMENU").appendField("touching"); this.setOutput(true, "Boolean"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_distanceto'] = { init: function() { this.appendValueInput("DISTANCETOMENU").appendField("distance to"); this.setOutput(true, "Number"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_askandwait'] = { init: function() { this.appendValueInput("QUESTION").appendField("ask"); this.appendDummyInput().appendField("and wait"); this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_answer'] = { init: function() { this.appendDummyInput().appendField("answer"); this.setOutput(true, "String"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_keypressed'] = { init: function() { this.appendValueInput("KEY_OPTION").appendField("key"); this.appendDummyInput().appendField("pressed?"); this.setInputsInline(true); this.setOutput(true, "Boolean"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_mousedown'] = { init: function() { this.appendDummyInput().appendField("mouse down?"); this.setOutput(true, "Boolean"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_mousex'] = { init: function() { this.appendDummyInput().appendField("mouse x"); this.setOutput(true, "Number"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_mousey'] = { init: function() { this.appendDummyInput().appendField("mouse y"); this.setOutput(true, "Number"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_timer'] = { init: function() { this.appendDummyInput().appendField("timer"); this.setOutput(true, "Number"); this.setColour("#4CBFE6"); } };
        Blockly.Blocks['sensing_resettimer'] = { init: function() { this.appendDummyInput().appendField("reset timer"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#4CBFE6"); } };

        // Operators
        // (Standard math blocks defined in toolbox, generators below cover them)
        Blockly.Blocks['operator_random'] = { init: function() { this.appendDummyInput().appendField("pick random"); this.appendValueInput("FROM").setCheck("Number"); this.appendDummyInput().appendField("to"); this.appendValueInput("TO").setCheck("Number"); this.setInputsInline(true); this.setOutput(true, "Number"); this.setColour("#40BF4A"); } };

        // ================== GENERATORS ==================
        const gen = javascript.javascriptGenerator;

        // Motion
        gen.forBlock['motion_move'] = (b) => `if(!self.isStage) { await blocklyRuntime.move(self, ${gen.valueToCode(b,'STEPS',javascript.Order.ATOMIC)||0}); }\n`;
        gen.forBlock['motion_turnright'] = (b) => `if(!self.isStage) { self.direction += ${gen.valueToCode(b,'DEGREES',javascript.Order.ATOMIC)||0}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        gen.forBlock['motion_turnleft'] = (b) => `if(!self.isStage) { self.direction -= ${gen.valueToCode(b,'DEGREES',javascript.Order.ATOMIC)||0}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        gen.forBlock['motion_pointindirection'] = (b) => `if(!self.isStage) { self.direction = ${gen.valueToCode(b,'DIRECTION',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        gen.forBlock['motion_changex'] = (b) => `if(!self.isStage) { self.x += ${gen.valueToCode(b,'DX',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        gen.forBlock['motion_setx'] = (b) => `if(!self.isStage) { self.x = 240 + ${gen.valueToCode(b,'X',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`; // 240 is center offset
        gen.forBlock['motion_changey'] = (b) => `if(!self.isStage) { self.y -= ${gen.valueToCode(b,'DY',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`; // Y is inverted in DOM
        gen.forBlock['motion_sety'] = (b) => `if(!self.isStage) { self.y = 180 - ${gen.valueToCode(b,'Y',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        
        gen.forBlock['motion_goto_xy'] = (b) => `if(!self.isStage) { self.x = 240 + ${gen.valueToCode(b,'X',javascript.Order.ATOMIC)}; self.y = 180 - ${gen.valueToCode(b,'Y',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        gen.forBlock['motion_goto_random'] = () => `if(!self.isStage) { self.x = Math.random() * state.stage.w; self.y = Math.random() * state.stage.h; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16); }\n`;
        
        gen.forBlock['motion_ifonedgebounce'] = () => `
            if(!self.isStage) {
                if(self.x < 20 || self.x > state.stage.w - 20) { self.direction = 180 - self.direction; self.x = self.x < 20 ? 25 : state.stage.w - 25; }
                if(self.y < 20 || self.y > state.stage.h - 20) { self.direction = 360 - self.direction; self.y = self.y < 20 ? 25 : state.stage.h - 25; }
                state.updateEntityVisuals(self);
            }
        \n`;
        
        gen.forBlock['motion_setrotationstyle'] = (b) => {
            const style = b.getFieldValue('STYLE');
            return `if(!self.isStage) { self.rotationStyle = '${style}'; state.updateEntityVisuals(self); }\n`;
        };

        gen.forBlock['motion_xposition'] = () => [`(self.x - 240)`, javascript.Order.ATOMIC];
        gen.forBlock['motion_yposition'] = () => [`(180 - self.y)`, javascript.Order.ATOMIC];
        gen.forBlock['motion_direction'] = () => [`self.direction`, javascript.Order.ATOMIC];

        // Looks
        gen.forBlock['looks_say'] = (b) => `
            if(self.bubble) { 
                self.bubble.innerText = ${gen.valueToCode(b,'MESSAGE',javascript.Order.ATOMIC)}; 
                self.bubble.classList.add('visible'); 
            }
            await blocklyRuntime.sleep(16);\n`;

        gen.forBlock['looks_sayforsecs'] = (b) => `
            if(self.bubble) { 
                self.bubble.innerText = ${gen.valueToCode(b,'MESSAGE',javascript.Order.ATOMIC)}; 
                self.bubble.classList.add('visible'); 
            }
            await blocklyRuntime.sleep(${gen.valueToCode(b,'SECS',javascript.Order.ATOMIC) * 1000});
            if(self.bubble) self.bubble.classList.remove('visible');\n`;

        gen.forBlock['looks_changesize'] = (b) => `self.size += ${gen.valueToCode(b,'CHANGE',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;
        gen.forBlock['looks_setsize'] = (b) => `self.size = ${gen.valueToCode(b,'SIZE',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;
        gen.forBlock['looks_show'] = () => `self.visible = true; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;
        gen.forBlock['looks_hide'] = () => `self.visible = false; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;
        
        gen.forBlock['looks_changeeffect'] = (b) => {
            const ef = b.getFieldValue('EFFECT').toLowerCase();
            return `self.effects.${ef} += ${gen.valueToCode(b,'CHANGE',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;
        };
        gen.forBlock['looks_seteffect'] = (b) => {
            const ef = b.getFieldValue('EFFECT').toLowerCase();
            return `self.effects.${ef} = ${gen.valueToCode(b,'VALUE',javascript.Order.ATOMIC)}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;
        };
        gen.forBlock['looks_cleareffects'] = () => `self.effects = {color:0,ghost:0,brightness:0}; state.updateEntityVisuals(self); await blocklyRuntime.sleep(16);\n`;

        // Sound
        gen.forBlock['sound_play'] = () => `playBeep();\n`;

        // Control
        gen.forBlock['control_wait'] = (b) => `await blocklyRuntime.sleep(${gen.valueToCode(b,'DURATION',javascript.Order.ATOMIC)*1000});\n`;
        gen.forBlock['control_forever'] = (b) => `while(true) {\n${gen.statementToCode(b,'DO')} await blocklyRuntime.sleep(16);\n}\n`;
        gen.forBlock['controls_repeat_ext'] = (b) => `for(let i=0; i<${gen.valueToCode(b,'TIMES',javascript.Order.ATOMIC)}; i++) {\n${gen.statementToCode(b,'DO')} await blocklyRuntime.sleep(16);\n}\n`;
        gen.forBlock['controls_if'] = (b) => `if(${gen.valueToCode(b,'IF0',javascript.Order.ATOMIC)}) {\n${gen.statementToCode(b,'DO0')}}\n`;
        gen.forBlock['controls_if_else'] = (b) => `if(${gen.valueToCode(b,'IF0',javascript.Order.ATOMIC)}) {\n${gen.statementToCode(b,'DO0')}} else {\n${gen.statementToCode(b,'ELSE')}}\n`;
        gen.forBlock['control_wait_until'] = (b) => `while(!(${gen.valueToCode(b,'CONDITION',javascript.Order.ATOMIC)})) { await blocklyRuntime.sleep(50); }\n`;
        gen.forBlock['control_repeat_until'] = (b) => `while(!(${gen.valueToCode(b,'CONDITION',javascript.Order.ATOMIC)})) { \n${gen.statementToCode(b,'DO')} await blocklyRuntime.sleep(16); }\n`;
        gen.forBlock['control_stop'] = () => `state.abortController.abort();\n`;
        
        // Clones
        gen.forBlock['control_create_clone'] = () => `state.createSprite(self.name, true, self);\n`;
        gen.forBlock['control_delete_this_clone'] = () => `
            if(self.isClone) {
                if(self.dom) self.dom.remove();
                state.clones = state.clones.filter(c => c !== self);
                throw new Error('ABORTED'); // Stop execution
            }
        \n`;
        gen.forBlock['control_start_as_clone'] = () => ``; // Handled by trigger

        // Events
        gen.forBlock['event_whenflagclicked'] = () => ``;
        gen.forBlock['event_whenkeypressed'] = () => ``;
        gen.forBlock['event_broadcast'] = (b) => `await state.triggerEvent('event_whenbroadcastreceived', null, 'MESSAGE', ${gen.valueToCode(b,'MESSAGE',javascript.Order.ATOMIC)});\n`;

        // Sensing
        gen.forBlock['sensing_mousedown'] = () => [`state.mouseDown`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_mousex'] = () => [`(state.mouseX - 240)`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_mousey'] = () => [`(180 - state.mouseY)`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_keypressed'] = (b) => [`state.keyState[${gen.valueToCode(b,'KEY_OPTION',javascript.Order.ATOMIC)}]`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_touchingobject'] = (b) => [`blocklyRuntime.checkCollision(self, ${gen.valueToCode(b,'TOUCHINGOBJECTMENU',javascript.Order.ATOMIC)})`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_distanceto'] = (b) => [`Math.sqrt(Math.pow(self.x - state.mouseX, 2) + Math.pow(self.y - state.mouseY, 2))`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_timer'] = () => [`(Date.now() - state.timerStart)/1000`, javascript.Order.ATOMIC];
        gen.forBlock['sensing_resettimer'] = () => `state.timerStart = Date.now();\n`;
        gen.forBlock['sensing_askandwait'] = (b) => `await blocklyRuntime.ask(${gen.valueToCode(b,'QUESTION',javascript.Order.ATOMIC)});\n`;
        gen.forBlock['sensing_answer'] = () => [`state.lastAnswer`, javascript.Order.ATOMIC];

        // Operators
        gen.forBlock['operator_random'] = (b) => {
            const from = gen.valueToCode(b,'FROM',javascript.Order.ATOMIC);
            const to = gen.valueToCode(b,'TO',javascript.Order.ATOMIC);
            return [`Math.floor(Math.random() * (${to} - ${from} + 1) + ${from})`, javascript.Order.ATOMIC];
        };
        gen.forBlock['operator_add'] = (b) => [`(${gen.valueToCode(b,'NUM1',javascript.Order.ATOMIC)} + ${gen.valueToCode(b,'NUM2',javascript.Order.ATOMIC)})`, javascript.Order.ADDITION];
        gen.forBlock['operator_subtract'] = (b) => [`(${gen.valueToCode(b,'NUM1',javascript.Order.ATOMIC)} - ${gen.valueToCode(b,'NUM2',javascript.Order.ATOMIC)})`, javascript.Order.SUBTRACTION];
        gen.forBlock['operator_gt'] = (b) => [`(${gen.valueToCode(b,'OPERAND1',javascript.Order.ATOMIC)} > ${gen.valueToCode(b,'OPERAND2',javascript.Order.ATOMIC)})`, javascript.Order.RELATIONAL];
        gen.forBlock['operator_lt'] = (b) => [`(${gen.valueToCode(b,'OPERAND1',javascript.Order.ATOMIC)} < ${gen.valueToCode(b,'OPERAND2',javascript.Order.ATOMIC)})`, javascript.Order.RELATIONAL];
        gen.forBlock['operator_equals'] = (b) => [`(${gen.valueToCode(b,'OPERAND1',javascript.Order.ATOMIC)} == ${gen.valueToCode(b,'OPERAND2',javascript.Order.ATOMIC)})`, javascript.Order.EQUALITY];
        gen.forBlock['operator_and'] = (b) => [`(${gen.valueToCode(b,'OPERAND1',javascript.Order.ATOMIC)} && ${gen.valueToCode(b,'OPERAND2',javascript.Order.ATOMIC)})`, javascript.Order.LOGICAL_AND];
        gen.forBlock['operator_or'] = (b) => [`(${gen.valueToCode(b,'OPERAND1',javascript.Order.ATOMIC)} || ${gen.valueToCode(b,'OPERAND2',javascript.Order.ATOMIC)})`, javascript.Order.LOGICAL_OR];
        gen.forBlock['operator_not'] = (b) => [`!${gen.valueToCode(b,'OPERAND',javascript.Order.ATOMIC)}`, javascript.Order.LOGICAL_NOT];
        gen.forBlock['operator_join'] = (b) => [`"" + ${gen.valueToCode(b,'STRING1',javascript.Order.ATOMIC)} + ${gen.valueToCode(b,'STRING2',javascript.Order.ATOMIC)}`, javascript.Order.ADDITION];


        // Initialize Blockly
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            theme: Blockly.Themes.Modern,
            renderer: 'zelos',
            zoom: { controls: true, startScale: 0.8 },
            grid: { spacing: 25, length: 2, colour: 'rgba(255,255,255,0.05)', snap: true },
            move: { scrollbars: true, drag: true, wheel: true },
            trashcan: true
        });

        // Initialize Everything
        window.onload = () => {
            state.init();
            Blockly.svgResize(workspace);
            logToConsole("System: Scratch Zenith initialized.");
        };

        window.addEventListener('resize', () => Blockly.svgResize(workspace));

        // Buttons
        document.getElementById('runBtn').onclick = () => {
            if (state.abortController) state.abortController.abort();
            state.abortController = new AbortController();
            
            // Cleanup clones
            state.clones.forEach(c => c.dom && c.dom.remove());
            state.clones = [];

            // Reset Timer
            state.timerStart = Date.now();

            logToConsole("Project: Started");
            state.triggerEvent('event_whenflagclicked');
        };

        document.getElementById('stopBtn').onclick = () => {
            if (state.abortController) state.abortController.abort();
            state.clones.forEach(c => c.dom && c.dom.remove());
            state.clones = [];
            
            // Hide all bubbles
            document.querySelectorAll('.speech-bubble').forEach(b => b.classList.remove('visible'));
            
            logToConsole("Project: Stopped");
        };

        document.getElementById('addSpriteBtn').onclick = () => {
            state.createSprite();
        };

        document.getElementById('demoBtn').onclick = () => {
            // Load a demo project XML into the active sprite
            const active = state.getActiveEntity();
            if(active) {
                const xml = `
                <xml xmlns="https://developers.google.com/blockly/xml">
                  <block type="event_whenflagclicked" x="50" y="50">
                    <next>
                      <block type="control_forever">
                        <statement name="DO">
                          <block type="controls_if">
                            <value name="IF0">
                              <block type="sensing_keypressed">
                                <value name="KEY_OPTION">
                                  <shadow type="text">
                                    <field name="TEXT">ArrowRight</field>
                                  </shadow>
                                </value>
                              </block>
                            </value>
                            <statement name="DO0">
                              <block type="motion_changeeffect">
                                <field name="EFFECT">COLOR</field>
                                <value name="CHANGE">
                                  <shadow type="math_number">
                                    <field name="NUM">5</field>
                                  </shadow>
                                </value>
                                <next>
                                  <block type="motion_move">
                                    <value name="STEPS">
                                      <shadow type="math_number">
                                        <field name="NUM">5</field>
                                      </shadow>
                                    </value>
                                    <next>
                                      <block type="motion_ifonedgebounce"></block>
                                    </next>
                                  </block>
                                </next>
                              </block>
                            </statement>
                          </block>
                        </statement>
                      </block>
                    </next>
                  </block>
                </xml>
                `;
                active.xml = xml;
                state.setActive(active.id);
                logToConsole("Loaded Demo: Color Walk");
            }
        };
        
        // Mod Panel
        document.getElementById('openModBtn').onclick = () => document.getElementById('modPanel').style.display = 'flex';
        document.getElementById('closeModBtn').onclick = () => document.getElementById('modPanel').style.display = 'none';

        // Saving
        document.getElementById('saveBtn').onclick = () => {
            const data = {
                entities: state.entities.map(e => ({...e, dom: null, bubble: null})),
                stageEntity: state.stageEntity
            };
            localStorage.setItem('project', JSON.stringify(data));
            logToConsole("System: Project Saved");
        };
        
        document.getElementById('loadBtn').onclick = () => {
            const data = JSON.parse(localStorage.getItem('project'));
            if(data) {
                document.getElementById('stage').innerHTML = '<div id="stage-backdrop"></div>';
                state.entities = [];
                state.clones = [];
                state.activeEntityId = null;
                
                data.entities.forEach(e => {
                    const ent = state.createSprite(e.name, false, e);
                    ent.xml = e.xml;
                });
                state.setActive(state.entities[0].id);
                state.updateGlobalUI();
                logToConsole("System: Project Loaded");
            }
        };

    </script>
</body>
</html>
